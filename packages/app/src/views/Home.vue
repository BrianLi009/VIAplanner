<template>
    <div>
        <v-row>
            <v-col class="py-0">
                <v-toolbar dark color="#012B5C">
                    <v-img
                        src="../assets/VIA-Planner-White.png"
                        max-width="130"
                        contain
                    />
                    <course-search-bar
                        :allCourses="formattedCourses"
                        class="mx-4"
                        :loadingParent="$apollo.loading"
                    />
                    <switch-sem />
                </v-toolbar>
            </v-col>
        </v-row>

        <v-container ref="exportMe">
            <v-row>
                <help-dial />
                <v-btn fab dark bottom left fixed color="primary" @click="print">
                </v-btn>
                <v-col class="mr-8 pb-0">
                    <timetable :timetable="timetable" />
                </v-col>
            </v-row>
            <v-row>
                <v-col class="pt-0">
                    <h1 style="text-align:center" class="text-subtitle-1">
                        Copyright ¬© 2020 VIAplanner - Data updated for the 2020 -
                        2021 school year
                    </h1>
                    <tutorial />
                    <timetable-course-card
                        class="my-4 mx-8"
                        v-for="(course, code) in getSelectedCourses(selectedCourses)"
                        :key="code"
                        :course="course"
                    />
                </v-col>
            </v-row>
        </v-container>
    </div>
</template>

<script>
import CourseSearchBar from "../components/CourseSearchBar";
import Timetable from "../components/Timetable";
import Tutorial from "../components/Tutorial";
import TimetableCourseCard from "../components/TimetableCourseCard";
import COURSES_SEARCH_BAR_QUERY from "../graphql/CoursesSearchBar.gql";
import SwitchSem from "../components/SwitchSem";
import HelpDial from "../components/HelpDial";
import { mapGetters } from "vuex";
import axios from "axios";

export default {
    created() {
        if (this.$isMobile()) {
            this.$router.push({ name: "about" });
        }
    },
    components: {
        SwitchSem,
        CourseSearchBar,
        Timetable,
        TimetableCourseCard,
        Tutorial,
        HelpDial,
    },
    computed: {
        ...mapGetters(["selectedCourses", "timetable"]),
        formattedCourses() {
            if (!this.courses) {
                return [];
            }
            return this.courses.map((course) => {
                if (course.code[8] === "F") {
                    return `üçÇ   ${course.code}: ${course.name}`;
                } else if (course.code[8] === "S") {
                    return `‚ùÑÔ∏è   ${course.code}: ${course.name}`;
                } else {
                    return `üçÇ‚ùÑÔ∏è ${course.code}: ${course.name}`;
                }
            });
        },
    },
    data() {
        return {
            optimizationOpen: false,
            exportURL: null,
        };
    },
    apollo: {
        courses: COURSES_SEARCH_BAR_QUERY,
    },
    methods: {
        // filters user lock timeslots
        getSelectedCourses(selectedCourses) {
            const filteredCourses = {};

            for (var code in selectedCourses) {
                if (!code.includes("Lock")) {
                    filteredCourses[code] = selectedCourses[code];
                }
            }

            return filteredCourses;
        },
        async print() {
            const el = this.$refs.exportMe;
            const options = {
                type: "dataURL",
            };
            this.exportURL = await this.$html2canvas(el, options);
            this.downloadWithAxios();
        },

        forceFileDownload(response) {
            const url = window.URL.createObjectURL(new Blob([response.data]));
            const link = document.createElement("a");
            link.href = url;
            link.setAttribute("download", "file.png"); //or any other extension
            document.body.appendChild(link);
            link.click();
            document.body.pop();
        },
        async downloadWithAxios() {
            try {
                let response = await axios({
                    method: "get",
                    url: this.exportURL,
                    responseType: "arraybuffer",
                });
                this.forceFileDownload(response);
            } catch {
                console.log("Download Failed");
            }
        },
    },
};
</script>
